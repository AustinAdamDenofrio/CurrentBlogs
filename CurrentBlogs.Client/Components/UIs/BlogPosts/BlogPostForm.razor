@inject ICategoryDTOService CategoryService

@if (Post is not null)
{
    <EditForm Model="Post" OnValidSubmit="HandleSubmit" class="row">
        <DataAnnotationsValidator />
        <div class="col-lg-4">
            @*Title*@
            <div class="mb-2">
                <label class="form-label">Title</label>
                <InputText class="form-control" @bind-Value="Post.Title"></InputText>
                <ValidationMessage For="() => Post.Title" />
            </div>
            @*Abstract*@
            <div class="mb-2">
                <label class="form-label">Abstract</label>
                <InputText class="form-control" @bind-Value="Post.Abstract"></InputText>
                <ValidationMessage For="() => Post.Abstract" />
            </div>
            @*Category*@
            <div class="mb-2">
                <label class="form-label">Category</label>
                <InputSelect class="form-control" @bind-Value="Post.CategoryId">
                    <option>Select a category...</option>
                    @foreach (CategoryDTO category in categories)
                    {
                        <option value="@category.Id">
                            @category.Name
                        </option>
                    }

                </InputSelect>
                <span class="text-danger">@categoryError </span>
                <ValidationMessage For="() => Post.CategoryId" />
            </div>
            @*Image*@
            <div class="mb-2">
                <img class="img-fluid rounded-5" style="max-height: 350px"
                     src="@(string.IsNullOrEmpty(Post.ImageUrl) ? ImageHelper.DefaultBlogImage : Post.ImageUrl)" />
                <InputFile OnChange="OnFileChange" class="form-control mt-3" accept=".png,.jpg,.jpeg,.svg" />

            </div>
        </div>
        <div class="col-lg-8 vstack gap-2">
            @*Post content and tags*@
            <div class=" flex-fill vstack">
                <label class="form-label">Content</label>
                <TinyMCE.Blazor.Editor ScriptSrc="/tinymce/tinymce.min.js"
                                       @bind-Value="Post.Content"
                                       Field="() => Post.Content"
                                       ClassName="rich-text-editor"
                                       Conf="editorConfig" />
                <ValidationMessage For="() => Post.Content" />


            </div>
            @*tag*@
            <div class="mb-2">
                <label class="form-label">Tags</label>
                <input class="form-control" />
            </div>
        </div>
        <div class="col-12 text-end">
            @* IsPublished checkbox *@
            <div class="form-check">
                <label class="form-check-label">
                    <InputCheckbox class="form-check-input" @bind-Value="Post.IsPublished">
                    </InputCheckbox>
                    Publish?
                </label>
            </div>
            @* Change location to author index for posts*@
            <a type="button" class="btn btn-outline-secondary" href="/">
                Cancel
            </a>
            <button type="submit" class="btn btn-primary">
                Save
            </button>
        </div>

        <ValidationSummary />
    </EditForm>
    @*
        TODO:
        -Slug
        -Updateddate
        -Created
        -IsDeleted
    *@
}


@code {
    #region Parameter
    [Parameter, EditorRequired]
    public BlogPostDTO? Post { get; set; }


    [Parameter, EditorRequired]
    public EventCallback<BlogPostDTO> OnSubmit { get; set; }

    #endregion

    #region State
    private IEnumerable<CategoryDTO> categories = [];

    private string? imageError;

    private string? categoryError = null;

    // tinyMCE config
    private static readonly Dictionary<string, object> editorConfig = new()
    {
        { "toolbar", "undo redo | bold italic underline | link codesample " },
        { "plugins", "anchor autolink link charmap preview table codesample" },
        { "default_link_target", "_blank" },
        { "link_assume_external_targets", true },
        { "link_context_toolbar", true },
        { "codesample_languages", new object[] {
                new { text = "HTML/XML", value = "markup" },
                new { text = "JavaScript", value = "javascript" },
                new { text = "CSS", value = "css" },
                new { text = "C#", value = "csharp" },
                new { text = "Razor", value = "razor" },
                new { text = "JSON", value = "json" },
    }
        },
        { "codesample_global_prismjs", true },
        { "promotion", false },
        { "height", "100%" },
    };
    #endregion


    #region Method
    protected override async Task OnInitializedAsync()
    {
        try
        {
            categories = await CategoryService.GetAllCategoriesAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
        }
    }

    private async Task HandleSubmit()
    {
        if (Post is not null && Post.CategoryId > 0)
        {
            try
            {
                await OnSubmit.InvokeAsync(Post);
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex);
            }

        }
        else
        {
            categoryError = "* Please select a category. Category is required.";
        }
    }

    private async Task OnFileChange(InputFileChangeEventArgs changeEvent)
    {
        imageError = null;

        if (changeEvent.File is null)
        {
            Post!.ImageUrl = ImageHelper.DefaultContactImage;
        }
        else if (changeEvent.File.Size > ImageHelper.MaxFileSize)
        {
            imageError = "Images must be less than 5 MB";
        }
        else
        {
            try
            {
                Post!.ImageUrl = await ImageHelper.GetDataUrl(changeEvent.File);
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex);
                imageError = "Could not read the selected file. Please select a different image.";
            }
        }
    }
    #endregion
}
